From c70bc683c9faf013401eb1b174bd11c28438ccf2 Mon Sep 17 00:00:00 2001
From: BlackMesa123 <giangrecosalvo9@gmail.com>
Date: Thu, 6 Jun 2024 01:10:15 +0200
Subject: [PATCH] Add optical FOD support

---
 .../keyguard/KeyguardSecUpdateMonitor.smali   |   6 +
 ...onitorImpl$$ExternalSyntheticLambda6.smali |  33 +-
 .../KeyguardSecUpdateMonitorImpl.smali        | 323 ++++++++++++++----
 smali/com/android/systemui/LsRune.smali       |   4 +
 .../plugin/PluginFaceWidgetManager.smali      |   6 +-
 .../features/GlobalActionFeatures.smali       |  35 +-
 ...ewMediator$$ExternalSyntheticLambda3.smali |  39 ++-
 ...ewMediator$$ExternalSyntheticLambda6.smali |  31 +-
 ...ationShadeWindowControllerHelperImpl.smali |  34 +-
 .../statusbar/phone/CentralSurfacesImpl.smali |  39 ++-
 .../phone/SecLsScrimControlHelper$1.smali     |   6 +-
 .../phone/SecLsScrimControlHelper.smali       |   8 +-
 .../phone/StatusBarKeyguardViewManager.smali  |   6 +-
 .../android/systemui/util/DeviceState.smali   |  34 +-
 ...Controller$$ExternalSyntheticLambda1.smali |   6 +-
 ...Controller$$ExternalSyntheticLambda7.smali |   6 +-
 .../KeyguardWallpaperController$2.smali       |   6 +-
 .../KeyguardWallpaperController$6.smali       |  12 +-
 .../KeyguardWallpaperController.smali         |  36 +-
 .../view/KeyguardAnimatedWallpaper.smali      |   6 +-
 .../view/KeyguardImageWallpaper.smali         |   6 +-
 .../view/KeyguardVideoWallpaper.smali         |  12 +-
 22 files changed, 537 insertions(+), 157 deletions(-)

diff --git a/smali/com/android/keyguard/KeyguardSecUpdateMonitor.smali b/smali/com/android/keyguard/KeyguardSecUpdateMonitor.smali
index 86fe71bf..4b42321c 100644
--- a/smali/com/android/keyguard/KeyguardSecUpdateMonitor.smali
+++ b/smali/com/android/keyguard/KeyguardSecUpdateMonitor.smali
@@ -822,6 +822,12 @@
     return-void
 .end method
 
+.method public removeMaskViewForOpticalFpSensor()V
+    .locals 0
+
+    return-void
+.end method
+
 .method public requestSessionClose()V
     .locals 0
 
diff --git a/smali/com/android/keyguard/KeyguardSecUpdateMonitorImpl$$ExternalSyntheticLambda6.smali b/smali/com/android/keyguard/KeyguardSecUpdateMonitorImpl$$ExternalSyntheticLambda6.smali
index f56d2239..81693e43 100644
--- a/smali/com/android/keyguard/KeyguardSecUpdateMonitorImpl$$ExternalSyntheticLambda6.smali
+++ b/smali/com/android/keyguard/KeyguardSecUpdateMonitorImpl$$ExternalSyntheticLambda6.smali
@@ -70,10 +70,41 @@
     :goto_0
     invoke-virtual {p0, v0}, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->updateFingerprintListeningState(I)V
 
-    sget-object p0, Lcom/android/systemui/LsRune;->VALUE_CONFIG_CARRIER_TEXT_POLICY:Ljava/lang/String;
+    sget-boolean p1, Lcom/android/systemui/LsRune;->SECURITY_FINGERPRINT_IN_DISPLAY_OPTICAL:Z
 
+    if-eqz p1, :cond_3
+
+    iget-object p1, p0, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mSettingsHelper:Lcom/android/systemui/util/SettingsHelper;
+
+    invoke-virtual {p1}, Lcom/android/systemui/util/SettingsHelper;->isOneHandModeRunning()Z
+
+    move-result p1
+
+    if-eqz p1, :cond_2
+
+    invoke-virtual {p0}, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->removeMaskViewForOpticalFpSensor()V
+
+    goto :goto_1
+
+    :cond_2
+    invoke-virtual {p0}, Lcom/android/keyguard/KeyguardUpdateMonitor;->isFingerprintDetectionRunning()Z
+
+    move-result p1
+
+    if-eqz p1, :cond_3
+
+    iget-object p1, p0, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mFpMaskToken:Landroid/os/IBinder;
+
+    if-nez p1, :cond_3
+
+    invoke-virtual {p0}, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->addMaskViewForOpticalFpSensor()V
+
+    :cond_3
+    :goto_1
     return-void
 
+    nop
+
     :pswitch_data_0
     .packed-switch 0x0
         :pswitch_0
diff --git a/smali/com/android/keyguard/KeyguardSecUpdateMonitorImpl.smali b/smali/com/android/keyguard/KeyguardSecUpdateMonitorImpl.smali
index 42592fb5..a939869b 100644
--- a/smali/com/android/keyguard/KeyguardSecUpdateMonitorImpl.smali
+++ b/smali/com/android/keyguard/KeyguardSecUpdateMonitorImpl.smali
@@ -74,6 +74,8 @@
 
 .field public mFpInDisplayState:I
 
+.field public mFpMaskToken:Landroid/os/IBinder;
+
 .field public final mFpMessages:Ljava/util/concurrent/ConcurrentLinkedQueue;
 
 .field public final mFpMsgConsumer:Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl$$ExternalSyntheticLambda8;
@@ -448,48 +450,50 @@
 
     iput-object v1, v2, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mDeviceOwnerInfoText:Ljava/lang/String;
 
-    new-instance v1, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl$2;
+    new-instance v6, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl$2;
 
-    invoke-direct {v1, v2}, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl$2;-><init>(Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;)V
+    invoke-direct {v6, v2}, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl$2;-><init>(Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;)V
 
-    iput-object v1, v2, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mSecureLockChangedCallback:Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl$2;
+    iput-object v6, v2, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mSecureLockChangedCallback:Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl$2;
 
-    new-instance v1, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl$$ExternalSyntheticLambda6;
+    new-instance v6, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl$$ExternalSyntheticLambda6;
 
-    invoke-direct {v1, v2, v4}, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl$$ExternalSyntheticLambda6;-><init>(Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;I)V
+    invoke-direct {v6, v2, v4}, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl$$ExternalSyntheticLambda6;-><init>(Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;I)V
 
-    iput-object v1, v2, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mSettingsCallbackForUPSM:Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl$$ExternalSyntheticLambda6;
+    iput-object v6, v2, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mSettingsCallbackForUPSM:Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl$$ExternalSyntheticLambda6;
 
-    const-string/jumbo v1, "ultra_powersaving_mode"
+    const-string/jumbo v6, "ultra_powersaving_mode"
 
-    invoke-static {v1}, Landroid/provider/Settings$System;->getUriFor(Ljava/lang/String;)Landroid/net/Uri;
+    invoke-static {v6}, Landroid/provider/Settings$System;->getUriFor(Ljava/lang/String;)Landroid/net/Uri;
 
-    move-result-object v1
+    move-result-object v6
 
-    const-string v6, "emergency_mode"
+    const-string v7, "emergency_mode"
 
-    invoke-static {v6}, Landroid/provider/Settings$System;->getUriFor(Ljava/lang/String;)Landroid/net/Uri;
+    invoke-static {v7}, Landroid/provider/Settings$System;->getUriFor(Ljava/lang/String;)Landroid/net/Uri;
 
-    move-result-object v6
+    move-result-object v7
 
-    filled-new-array {v1, v6}, [Landroid/net/Uri;
+    filled-new-array {v6, v7}, [Landroid/net/Uri;
 
-    move-result-object v1
+    move-result-object v6
 
-    iput-object v1, v2, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mSettingsValueListForPSM:[Landroid/net/Uri;
+    iput-object v6, v2, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mSettingsValueListForPSM:[Landroid/net/Uri;
 
-    new-instance v1, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl$3;
+    new-instance v6, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl$3;
 
-    invoke-direct {v1, v2}, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl$3;-><init>(Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;)V
+    invoke-direct {v6, v2}, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl$3;-><init>(Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;)V
 
-    iput-object v1, v2, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mDisplayListener:Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl$3;
+    iput-object v6, v2, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mDisplayListener:Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl$3;
 
-    new-array v1, v3, [Z
+    new-array v3, v3, [Z
 
-    iput-object v1, v2, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mESimRemoved:[Z
+    iput-object v3, v2, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mESimRemoved:[Z
 
     iput v4, v2, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mFpInDisplayState:I
 
+    iput-object v1, v2, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mFpMaskToken:Landroid/os/IBinder;
+
     iput-boolean v4, v2, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mIsShortcutLaunchInProgress:Z
 
     iput-boolean v4, v2, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mIsPanelExpandingStarted:Z
@@ -995,6 +999,41 @@
     return-void
 .end method
 
+.method public final addMaskViewForOpticalFpSensor()V
+    .locals 2
+
+    iget-object v0, p0, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mFpm:Landroid/hardware/fingerprint/FingerprintManager;
+
+    if-eqz v0, :cond_0
+
+    iget-object v0, p0, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mFpMaskToken:Landroid/os/IBinder;
+
+    if-nez v0, :cond_0
+
+    const-string v0, "KeyguardFingerprint"
+
+    const-string/jumbo v1, "semAddMaskView()"
+
+    invoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
+
+    iget-object v0, p0, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mFpm:Landroid/hardware/fingerprint/FingerprintManager;
+
+    invoke-virtual {v0}, Landroid/hardware/fingerprint/FingerprintManager;->semAddMaskView()Landroid/os/IBinder;
+
+    move-result-object v0
+
+    iput-object v0, p0, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mFpMaskToken:Landroid/os/IBinder;
+
+    const/4 v0, 0x1
+
+    const/4 v1, 0x3
+
+    invoke-virtual {p0, v1, v0}, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->setFocusForBiometrics(IZ)V
+
+    :cond_0
+    return-void
+.end method
+
 .method public final checkValidPrevCredentialType()Z
     .locals 2
 
@@ -4795,18 +4834,23 @@
     goto :goto_0
 
     :cond_0
-    sget-object v0, Lcom/android/systemui/LsRune;->VALUE_CONFIG_CARRIER_TEXT_POLICY:Ljava/lang/String;
+    sget-boolean v0, Lcom/android/systemui/LsRune;->SECURITY_FINGERPRINT_IN_DISPLAY_OPTICAL:Z
 
+    if-eqz v0, :cond_1
+
+    invoke-virtual {p0}, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->removeMaskViewForOpticalFpSensor()V
+
+    :cond_1
     :goto_0
     sget-boolean v0, Lcom/android/systemui/LsRune;->SECURITY_FINGERPRINT_IN_DISPLAY:Z
 
-    if-eqz v0, :cond_1
+    if-eqz v0, :cond_2
 
     iget v0, p0, Lcom/android/keyguard/KeyguardUpdateMonitor;->mFingerprintRunningState:I
 
     const/4 v1, 0x1
 
-    if-ne v0, v1, :cond_1
+    if-ne v0, v1, :cond_2
 
     const-string v0, "KeyguardFingerprint"
 
@@ -4816,7 +4860,7 @@
 
     invoke-virtual {p0}, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->stopListeningForFingerprint()V
 
-    :cond_1
+    :cond_2
     new-instance v0, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl$$ExternalSyntheticLambda18;
 
     const/4 v1, 0x0
@@ -4839,11 +4883,11 @@
 
     sget-boolean p1, Lcom/android/systemui/LsRune;->SECURITY_SUB_DISPLAY_COVER:Z
 
-    if-eqz p1, :cond_2
+    if-eqz p1, :cond_3
 
     iput-boolean v1, p0, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mNeedSubBioAuth:Z
 
-    :cond_2
+    :cond_3
     return-void
 .end method
 
@@ -5273,9 +5317,33 @@
     return-void
 
     :cond_0
+    sget-boolean v0, Lcom/android/systemui/LsRune;->SECURITY_FINGERPRINT_IN_DISPLAY_OPTICAL:Z
+
+    if-eqz v0, :cond_2
+
+    invoke-virtual {p0}, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->is2StepVerification()Z
+
+    move-result v0
+
+    if-nez v0, :cond_1
+
+    invoke-virtual {p0}, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->isForcedLock()Z
+
+    move-result v0
+
+    if-nez v0, :cond_1
+
+    iget-boolean v0, p0, Lcom/android/keyguard/KeyguardUpdateMonitor;->mKeyguardShowing:Z
+
+    if-nez v0, :cond_2
+
+    :cond_1
+    invoke-virtual {p0}, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->removeMaskViewForOpticalFpSensor()V
+
+    :cond_2
     sget-boolean v0, Lcom/android/systemui/LsRune;->SECURITY_SUB_DISPLAY_COVER:Z
 
-    if-eqz v0, :cond_1
+    if-eqz v0, :cond_3
 
     iput-boolean v1, p0, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mForceStartFinger:Z
 
@@ -5283,7 +5351,7 @@
 
     iput-boolean v1, p0, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mNeedSubWofFpAuth:Z
 
-    :cond_1
+    :cond_3
     invoke-super {p0, p1, p2}, Lcom/android/keyguard/KeyguardUpdateMonitor;->handleFingerprintAuthenticated(IZ)V
 
     return-void
@@ -5337,7 +5405,7 @@
     :cond_2
     const/16 v0, 0x3ea
 
-    if-eq v0, p1, :cond_5
+    if-eq v0, p1, :cond_6
 
     const/16 v0, 0x3eb
 
@@ -5348,13 +5416,15 @@
     :cond_3
     const/16 v0, 0x3e9
 
-    if-ne v0, p1, :cond_4
+    if-ne v0, p1, :cond_5
+
+    sget-boolean p2, Lcom/android/systemui/LsRune;->SECURITY_FINGERPRINT_IN_DISPLAY_OPTICAL:Z
 
-    sget-object p2, Lcom/android/systemui/LsRune;->VALUE_CONFIG_CARRIER_TEXT_POLICY:Ljava/lang/String;
+    if-eqz p2, :cond_4
 
     iget-object p2, p0, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mContext:Landroid/content/Context;
 
-    const v0, 0x7f13083f
+    const v0, 0x7f13083c
 
     invoke-virtual {p2, v0}, Landroid/content/Context;->getString(I)Ljava/lang/String;
 
@@ -5363,9 +5433,20 @@
     goto :goto_1
 
     :cond_4
+    iget-object p2, p0, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mContext:Landroid/content/Context;
+
+    const v0, 0x7f13083f
+
+    invoke-virtual {p2, v0}, Landroid/content/Context;->getString(I)Ljava/lang/String;
+
+    move-result-object p2
+
+    goto :goto_1
+
+    :cond_5
     const/16 v0, 0x3ed
 
-    if-ne v0, p1, :cond_6
+    if-ne v0, p1, :cond_7
 
     iget-object p2, p0, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mContext:Landroid/content/Context;
 
@@ -5377,7 +5458,7 @@
 
     goto :goto_1
 
-    :cond_5
+    :cond_6
     :goto_0
     iget-object p2, p0, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mContext:Landroid/content/Context;
 
@@ -5387,7 +5468,7 @@
 
     move-result-object p2
 
-    :cond_6
+    :cond_7
     :goto_1
     iget-object v0, p0, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mPowerManager:Landroid/os/PowerManager;
 
@@ -5401,21 +5482,21 @@
 
     sget-boolean v0, Lcom/android/systemui/LsRune;->SECURITY_BACKGROUND_AUTHENTICATION:Z
 
-    if-eqz v0, :cond_7
+    if-eqz v0, :cond_8
 
     const/4 v0, 0x5
 
-    if-ne p1, v0, :cond_7
+    if-ne p1, v0, :cond_8
 
     iget-boolean v0, p0, Lcom/android/keyguard/KeyguardUpdateMonitor;->mKeyguardOccluded:Z
 
-    if-eqz v0, :cond_7
+    if-eqz v0, :cond_8
 
     iget v0, p0, Lcom/android/keyguard/KeyguardUpdateMonitor;->mFingerprintRunningState:I
 
     const/4 v3, 0x1
 
-    if-ne v0, v3, :cond_7
+    if-ne v0, v3, :cond_8
 
     const-string v0, "mIsFPCanceledByForegroundApp true"
 
@@ -5425,7 +5506,7 @@
 
     invoke-virtual {p0, v1}, Lcom/android/keyguard/KeyguardUpdateMonitor;->setFingerprintRunningState(I)V
 
-    :cond_7
+    :cond_8
     invoke-super {p0, p1, p2}, Lcom/android/keyguard/KeyguardUpdateMonitor;->handleFingerprintError(ILjava/lang/String;)V
 
     return-void
@@ -12031,6 +12112,37 @@
     return-void
 .end method
 
+.method public final removeMaskViewForOpticalFpSensor()V
+    .locals 2
+
+    iget-object v0, p0, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mFpm:Landroid/hardware/fingerprint/FingerprintManager;
+
+    if-eqz v0, :cond_0
+
+    iget-object v0, p0, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mFpMaskToken:Landroid/os/IBinder;
+
+    if-eqz v0, :cond_0
+
+    const-string v0, "KeyguardFingerprint"
+
+    const-string/jumbo v1, "semRemoveMaskView()"
+
+    invoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
+
+    iget-object v0, p0, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mFpm:Landroid/hardware/fingerprint/FingerprintManager;
+
+    iget-object v1, p0, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mFpMaskToken:Landroid/os/IBinder;
+
+    invoke-virtual {v0, v1}, Landroid/hardware/fingerprint/FingerprintManager;->semRemoveMaskView(Landroid/os/IBinder;)I
+
+    const/4 v0, 0x0
+
+    iput-object v0, p0, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mFpMaskToken:Landroid/os/IBinder;
+
+    :cond_0
+    return-void
+.end method
+
 .method public final reportFailedBiometricUnlockAttempt(I)V
     .locals 9
 
@@ -12182,7 +12294,7 @@
 
     move-result v0
 
-    if-eqz v0, :cond_1
+    if-eqz v0, :cond_2
 
     new-instance v0, Ljava/lang/StringBuilder;
 
@@ -12208,18 +12320,23 @@
 
     move-result v0
 
+    if-eqz v0, :cond_1
+
+    sget-boolean v0, Lcom/android/systemui/LsRune;->SECURITY_FINGERPRINT_IN_DISPLAY_OPTICAL:Z
+
     if-eqz v0, :cond_0
 
-    sget-object v0, Lcom/android/systemui/LsRune;->VALUE_CONFIG_CARRIER_TEXT_POLICY:Ljava/lang/String;
+    invoke-virtual {p0}, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->removeMaskViewForOpticalFpSensor()V
 
+    :cond_0
     invoke-virtual {p0}, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->stopListeningForFingerprint()V
 
     goto :goto_0
 
-    :cond_0
+    :cond_1
     iget-object v0, p0, Lcom/android/keyguard/KeyguardUpdateMonitor;->mFingerprintCancelSignal:Landroid/os/CancellationSignal;
 
-    if-eqz v0, :cond_1
+    if-eqz v0, :cond_2
 
     invoke-virtual {v0}, Landroid/os/CancellationSignal;->cancel()V
 
@@ -12227,7 +12344,7 @@
 
     iput-object v0, p0, Lcom/android/keyguard/KeyguardUpdateMonitor;->mFingerprintCancelSignal:Landroid/os/CancellationSignal;
 
-    :cond_1
+    :cond_2
     :goto_0
     const-class v0, Lcom/android/systemui/UiOffloadThread;
 
@@ -13536,7 +13653,7 @@
 
     iput-boolean p1, p0, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mKeyguardUnlocking:Z
 
-    if-eqz p1, :cond_1
+    if-eqz p1, :cond_2
 
     invoke-virtual {p0}, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->stopListeningForFingerprint()V
 
@@ -13544,8 +13661,13 @@
 
     invoke-virtual {p0, p1}, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->stopListeningForFace(Lcom/android/keyguard/FaceAuthUiEvent;)V
 
-    sget-object p1, Lcom/android/systemui/LsRune;->VALUE_CONFIG_CARRIER_TEXT_POLICY:Ljava/lang/String;
+    sget-boolean p1, Lcom/android/systemui/LsRune;->SECURITY_FINGERPRINT_IN_DISPLAY_OPTICAL:Z
 
+    if-eqz p1, :cond_1
+
+    invoke-virtual {p0}, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->removeMaskViewForOpticalFpSensor()V
+
+    :cond_1
     new-instance p1, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl$$ExternalSyntheticLambda10;
 
     const/4 v0, 0x0
@@ -13556,7 +13678,7 @@
 
     invoke-virtual {p0, v0, p1}, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->dispatchCallback(Ljava/lang/String;Ljava/util/function/Consumer;)V
 
-    :cond_1
+    :cond_2
     return-void
 .end method
 
@@ -16695,9 +16817,9 @@
 
     invoke-static {v5, v4}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
 
-    if-eqz v2, :cond_4
+    if-eqz v2, :cond_5
 
-    if-nez v1, :cond_4
+    if-nez v1, :cond_5
 
     if-nez p1, :cond_3
 
@@ -16706,72 +16828,124 @@
     :cond_3
     iget p1, p0, Lcom/android/keyguard/KeyguardUpdateMonitor;->mFingerprintRunningState:I
 
-    if-ne p1, v3, :cond_7
+    if-ne p1, v3, :cond_9
+
+    sget-boolean p1, Lcom/android/systemui/LsRune;->SECURITY_FINGERPRINT_IN_DISPLAY_OPTICAL:Z
+
+    if-eqz p1, :cond_4
+
+    iget-boolean p1, p0, Lcom/android/keyguard/KeyguardUpdateMonitor;->mKeyguardShowing:Z
+
+    if-nez p1, :cond_4
 
-    sget-object p1, Lcom/android/systemui/LsRune;->VALUE_CONFIG_CARRIER_TEXT_POLICY:Ljava/lang/String;
+    invoke-virtual {p0}, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->removeMaskViewForOpticalFpSensor()V
 
+    :cond_4
     invoke-virtual {p0}, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->stopListeningForFingerprint()V
 
     goto :goto_2
 
-    :cond_4
-    if-nez v2, :cond_6
+    :cond_5
+    if-nez v2, :cond_8
 
-    if-eqz v1, :cond_6
+    if-eqz v1, :cond_8
 
-    if-ne p1, v3, :cond_5
+    if-ne p1, v3, :cond_6
 
     return-void
 
-    :cond_5
-    sget-object p1, Lcom/android/systemui/LsRune;->VALUE_CONFIG_CARRIER_TEXT_POLICY:Ljava/lang/String;
+    :cond_6
+    sget-boolean p1, Lcom/android/systemui/LsRune;->SECURITY_FINGERPRINT_IN_DISPLAY_OPTICAL:Z
+
+    if-eqz p1, :cond_7
+
+    iget-object p1, p0, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mSettingsHelper:Lcom/android/systemui/util/SettingsHelper;
+
+    invoke-virtual {p1}, Lcom/android/systemui/util/SettingsHelper;->isOneHandModeRunning()Z
+
+    move-result p1
+
+    if-nez p1, :cond_7
 
+    invoke-virtual {p0}, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->addMaskViewForOpticalFpSensor()V
+
+    :cond_7
     invoke-virtual {p0}, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->startListeningForFingerprint()V
 
     goto :goto_2
 
-    :cond_6
-    if-nez v2, :cond_7
+    :cond_8
+    if-nez v2, :cond_9
 
-    if-nez v1, :cond_7
+    if-nez v1, :cond_9
 
-    sget-object p1, Lcom/android/systemui/LsRune;->VALUE_CONFIG_CARRIER_TEXT_POLICY:Ljava/lang/String;
+    sget-boolean p1, Lcom/android/systemui/LsRune;->SECURITY_FINGERPRINT_IN_DISPLAY_OPTICAL:Z
 
-    :cond_7
+    if-eqz p1, :cond_9
+
+    invoke-virtual {p0}, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->isFingerprintOptionEnabled()Z
+
+    move-result p1
+
+    if-eqz p1, :cond_9
+
+    sget-boolean p1, Lcom/android/systemui/LsRune;->COVER_SUPPORTED:Z
+
+    if-eqz p1, :cond_9
+
+    invoke-virtual {p0}, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->isCoverClosed()Z
+
+    move-result p1
+
+    if-eqz p1, :cond_9
+
+    iget-boolean p1, p0, Lcom/android/keyguard/KeyguardUpdateMonitor;->mKeyguardShowing:Z
+
+    if-eqz p1, :cond_9
+
+    invoke-virtual {p0}, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->addMaskViewForOpticalFpSensor()V
+
+    :cond_9
     :goto_2
     sget-boolean p1, Lcom/android/systemui/LsRune;->SECURITY_FINGERPRINT_IN_DISPLAY:Z
 
-    if-eqz p1, :cond_a
+    if-eqz p1, :cond_c
 
-    if-nez v1, :cond_8
+    if-nez v1, :cond_a
 
-    goto :goto_3
+    sget-boolean p1, Lcom/android/systemui/LsRune;->SECURITY_FINGERPRINT_IN_DISPLAY_OPTICAL:Z
 
-    :cond_8
+    if-eqz p1, :cond_c
+
+    iget-object p1, p0, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mFpMaskToken:Landroid/os/IBinder;
+
+    if-eqz p1, :cond_c
+
+    :cond_a
     iget-boolean p1, p0, Lcom/android/keyguard/KeyguardUpdateMonitor;->mDeviceInteractive:Z
 
-    if-eqz p1, :cond_9
+    if-eqz p1, :cond_b
 
     iget-boolean p1, p0, Lcom/android/keyguard/KeyguardUpdateMonitor;->mGoingToSleep:Z
 
-    if-nez p1, :cond_9
+    if-nez p1, :cond_b
 
     iget-boolean p1, p0, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mIsDreamingForBiometrics:Z
 
-    if-nez p1, :cond_9
+    if-nez p1, :cond_b
 
     move v0, v3
 
-    :cond_9
+    :cond_b
     xor-int/lit8 p1, v0, 0x1
 
     iget v0, p0, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mFpInDisplayState:I
 
-    if-eq v0, p1, :cond_a
+    if-eq v0, p1, :cond_c
 
     iget-object v0, p0, Lcom/android/keyguard/KeyguardSecUpdateMonitorImpl;->mFpm:Landroid/hardware/fingerprint/FingerprintManager;
 
-    if-eqz v0, :cond_a
+    if-eqz v0, :cond_c
 
     new-instance v0, Ljava/lang/StringBuilder;
 
@@ -16791,8 +16965,7 @@
 
     invoke-virtual {p0, p1}, Landroid/hardware/fingerprint/FingerprintManager;->semSetScreenStatus(I)I
 
-    :cond_a
-    :goto_3
+    :cond_c
     return-void
 .end method
 
diff --git a/smali/com/android/systemui/LsRune.smali b/smali/com/android/systemui/LsRune.smali
index 9a39c2c1..cf794518 100644
--- a/smali/com/android/systemui/LsRune.smali
+++ b/smali/com/android/systemui/LsRune.smali
@@ -128,6 +128,8 @@
 
 .field public static final SECURITY_FINGERPRINT_IN_DISPLAY:Z
 
+.field public static final SECURITY_FINGERPRINT_IN_DISPLAY_OPTICAL:Z
+
 .field public static final SECURITY_HAPTIC_FEEDBACK_ON_DC_MOTOR:Z
 
 .field public static final SECURITY_HIDE_EMERGENCY_BUTTON_BY_SIMSTATE:Z
@@ -806,6 +808,8 @@
 
     sput-boolean v3, Lcom/android/systemui/LsRune;->SECURITY_FINGERPRINT_IN_DISPLAY:Z
 
+    sput-boolean v3, Lcom/android/systemui/LsRune;->SECURITY_FINGERPRINT_IN_DISPLAY_OPTICAL:Z
+
     const/4 v3, 0x0
 
     sput-boolean v3, Lcom/android/systemui/LsRune;->SECURITY_BACKGROUND_AUTHENTICATION:Z
diff --git a/smali/com/android/systemui/facewidget/plugin/PluginFaceWidgetManager.smali b/smali/com/android/systemui/facewidget/plugin/PluginFaceWidgetManager.smali
index 293586e5..be78cb56 100644
--- a/smali/com/android/systemui/facewidget/plugin/PluginFaceWidgetManager.smali
+++ b/smali/com/android/systemui/facewidget/plugin/PluginFaceWidgetManager.smali
@@ -544,7 +544,11 @@
 
     if-eqz p0, :cond_0
 
-    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()V
+    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()Z
+
+    move-result p0
+
+    if-eqz p0, :cond_0
 
     const/4 p0, 0x1
 
diff --git a/smali/com/android/systemui/globalactions/presentation/features/GlobalActionFeatures.smali b/smali/com/android/systemui/globalactions/presentation/features/GlobalActionFeatures.smali
index ba1d3ca9..440947a9 100644
--- a/smali/com/android/systemui/globalactions/presentation/features/GlobalActionFeatures.smali
+++ b/smali/com/android/systemui/globalactions/presentation/features/GlobalActionFeatures.smali
@@ -44,7 +44,7 @@
 
     sget-boolean v0, Lcom/android/systemui/BasicRune;->GLOBALACTIONS_BLUR:Z
 
-    goto/16 :goto_4
+    goto/16 :goto_5
 
     :cond_0
     const-string v0, "CAPTURED_BLUR"
@@ -57,7 +57,7 @@
 
     sget-boolean v0, Lcom/android/systemui/BasicRune;->GLOBALACTIONS_CAPTURED_BLUR:Z
 
-    goto/16 :goto_4
+    goto/16 :goto_5
 
     :cond_1
     const-string v0, "NAV_BAR"
@@ -80,7 +80,7 @@
 
     move-result v0
 
-    goto/16 :goto_4
+    goto/16 :goto_5
 
     :cond_2
     const-string v0, "SAFETY_CARE"
@@ -101,7 +101,7 @@
 
     move-result v0
 
-    goto/16 :goto_4
+    goto/16 :goto_5
 
     :cond_3
     const-string v0, "SCOVER"
@@ -116,7 +116,7 @@
 
     move-result v0
 
-    goto/16 :goto_4
+    goto/16 :goto_5
 
     :cond_4
     const-string v0, "DATA_MODE"
@@ -137,7 +137,7 @@
 
     move-result v0
 
-    goto/16 :goto_4
+    goto/16 :goto_5
 
     :cond_5
     const-string v0, "DEMO_MODE"
@@ -258,7 +258,7 @@
 
     move-result v0
 
-    goto/16 :goto_4
+    goto/16 :goto_5
 
     :cond_b
     const-string v0, "FINGERPRINT_IN_DISPLAY"
@@ -271,7 +271,13 @@
 
     sget-boolean v0, Lcom/android/systemui/LsRune;->SECURITY_FINGERPRINT_IN_DISPLAY:Z
 
-    goto/16 :goto_4
+    if-nez v0, :cond_15
+
+    sget-boolean v0, Lcom/android/systemui/LsRune;->SECURITY_FINGERPRINT_IN_DISPLAY_OPTICAL:Z
+
+    if-eqz v0, :cond_16
+
+    goto/16 :goto_3
 
     :cond_c
     const-string v0, "SUPPORT_SIDE_KEY"
@@ -292,7 +298,7 @@
 
     move-result v0
 
-    goto/16 :goto_4
+    goto/16 :goto_5
 
     :cond_d
     const-string v0, "POWER_OFF_LOCK"
@@ -313,7 +319,7 @@
 
     move-result v0
 
-    goto/16 :goto_4
+    goto/16 :goto_5
 
     :cond_e
     const-string v0, "FRONT_LARGE_COVER_DISPLAY"
@@ -332,7 +338,7 @@
 
     move-result v0
 
-    goto/16 :goto_4
+    goto/16 :goto_5
 
     :cond_f
     const-string v0, "FRONT_COVER_DISPLAY"
@@ -372,7 +378,7 @@
 
     if-eqz v0, :cond_11
 
-    goto :goto_3
+    goto :goto_4
 
     :cond_11
     const-string v0, "KNOX_SDK"
@@ -448,12 +454,13 @@
     :goto_3
     move v0, v1
 
-    goto :goto_4
+    goto :goto_5
 
     :cond_16
+    :goto_4
     move v0, v2
 
-    :goto_4
+    :goto_5
     iget-object p0, p0, Lcom/android/systemui/globalactions/presentation/features/GlobalActionFeatures;->mLogWrapper:Lcom/samsung/android/globalactions/util/LogWrapper;
 
     new-instance v1, Ljava/lang/StringBuilder;
diff --git a/smali/com/android/systemui/keyguard/KeyguardViewMediator$$ExternalSyntheticLambda3.smali b/smali/com/android/systemui/keyguard/KeyguardViewMediator$$ExternalSyntheticLambda3.smali
index 6ac0c258..71532339 100644
--- a/smali/com/android/systemui/keyguard/KeyguardViewMediator$$ExternalSyntheticLambda3.smali
+++ b/smali/com/android/systemui/keyguard/KeyguardViewMediator$$ExternalSyntheticLambda3.smali
@@ -277,10 +277,17 @@
 
     move-result v0
 
+    if-eqz v0, :cond_9
+
+    sget-boolean v0, Lcom/android/systemui/LsRune;->SECURITY_FINGERPRINT_IN_DISPLAY_OPTICAL:Z
+
     if-eqz v0, :cond_8
 
-    sget-object v0, Lcom/android/systemui/LsRune;->VALUE_CONFIG_CARRIER_TEXT_POLICY:Ljava/lang/String;
+    iget-object v0, p0, Lcom/android/systemui/keyguard/KeyguardViewMediatorHelperImpl;->updateMonitor:Lcom/android/keyguard/KeyguardUpdateMonitor;
 
+    invoke-interface {v0}, Lcom/android/keyguard/KeyguardSecUpdateMonitor;->removeMaskViewForOpticalFpSensor()V
+
+    :cond_8
     invoke-virtual {p0}, Lcom/android/systemui/keyguard/KeyguardViewMediatorHelperImpl;->removeShowMsg()V
 
     iget-object p0, p0, Lcom/android/systemui/keyguard/KeyguardViewMediatorHelperImpl;->viewControllerLazy:Ldagger/Lazy;
@@ -295,7 +302,7 @@
 
     goto :goto_5
 
-    :cond_8
+    :cond_9
     move v1, v2
 
     :goto_5
@@ -308,7 +315,7 @@
 
     move-result v0
 
-    if-eqz v0, :cond_a
+    if-eqz v0, :cond_b
 
     iget-object v0, p0, Lcom/android/systemui/keyguard/KeyguardViewMediatorHelperImpl;->activityManager:Landroid/app/ActivityManager;
 
@@ -316,30 +323,30 @@
 
     move-result v0
 
-    if-eqz v0, :cond_9
+    if-eqz v0, :cond_a
 
     move v0, v1
 
     goto :goto_6
 
-    :cond_9
+    :cond_a
     move v0, v2
 
     :goto_6
-    if-eqz v0, :cond_b
+    if-eqz v0, :cond_c
 
-    :cond_a
+    :cond_b
     iget-object p0, p0, Lcom/android/systemui/keyguard/KeyguardViewMediatorHelperImpl;->updateMonitor:Lcom/android/keyguard/KeyguardUpdateMonitor;
 
     invoke-interface {p0}, Lcom/android/keyguard/KeyguardSecUpdateMonitor;->isForcedLock()Z
 
     move-result p0
 
-    if-nez p0, :cond_b
+    if-nez p0, :cond_c
 
     goto :goto_7
 
-    :cond_b
+    :cond_c
     move v1, v2
 
     :goto_7
@@ -362,15 +369,15 @@
 
     iget v4, v3, Lcom/android/systemui/keyguard/KeyguardVisibilityMonitor;->curVisibility:I
 
-    if-nez v4, :cond_c
+    if-nez v4, :cond_d
 
     goto :goto_9
 
-    :cond_c
+    :cond_d
     move v1, v2
 
     :goto_9
-    if-eqz v1, :cond_d
+    if-eqz v1, :cond_e
 
     iget-object v0, v0, Lcom/android/keyguard/KeyguardDisplayManager;->mVisibilityListener:Lcom/android/keyguard/KeyguardDisplayManager$$ExternalSyntheticLambda0;
 
@@ -378,13 +385,13 @@
 
     goto :goto_a
 
-    :cond_d
+    :cond_e
     invoke-virtual {v0}, Lcom/android/keyguard/KeyguardDisplayManager;->hide()V
 
     :goto_a
     iget-boolean v0, p0, Lcom/android/systemui/keyguard/KeyguardViewMediatorHelperImpl;->isAODShowStateCbRegistered:Z
 
-    if-eqz v0, :cond_e
+    if-eqz v0, :cond_f
 
     iget-object v0, p0, Lcom/android/systemui/keyguard/KeyguardViewMediatorHelperImpl;->aodShowStateCallback:Lcom/android/systemui/keyguard/KeyguardViewMediatorHelperImpl$aodShowStateCallback$1;
 
@@ -392,7 +399,7 @@
 
     invoke-virtual {v1, v0}, Lcom/android/systemui/util/SettingsHelper;->unregisterCallback(Lcom/android/systemui/util/SettingsHelper$OnChangedCallback;)V
 
-    :cond_e
+    :cond_f
     iput-boolean v2, p0, Lcom/android/systemui/keyguard/KeyguardViewMediatorHelperImpl;->isAODShowStateCbRegistered:Z
 
     new-instance v0, Lcom/android/systemui/keyguard/KeyguardViewMediatorHelperImpl$registerSysDumpHeap$1;
@@ -405,8 +412,6 @@
 
     return v2
 
-    nop
-
     :pswitch_data_0
     .packed-switch 0x0
         :pswitch_4
diff --git a/smali/com/android/systemui/keyguard/KeyguardViewMediator$$ExternalSyntheticLambda6.smali b/smali/com/android/systemui/keyguard/KeyguardViewMediator$$ExternalSyntheticLambda6.smali
index 77f10462..213f8318 100644
--- a/smali/com/android/systemui/keyguard/KeyguardViewMediator$$ExternalSyntheticLambda6.smali
+++ b/smali/com/android/systemui/keyguard/KeyguardViewMediator$$ExternalSyntheticLambda6.smali
@@ -493,8 +493,37 @@
     move v8, v6
 
     :goto_a
-    sget-object v13, Lcom/android/systemui/LsRune;->VALUE_CONFIG_CARRIER_TEXT_POLICY:Ljava/lang/String;
+    sget-boolean v13, Lcom/android/systemui/LsRune;->SECURITY_FINGERPRINT_IN_DISPLAY_OPTICAL:Z
 
+    if-eqz v13, :cond_mesa2
+
+    invoke-virtual {v12}, Lcom/android/systemui/keyguard/KeyguardFastBioUnlockController;->isEnabled()Z
+
+    move-result v13
+
+    if-eqz v13, :cond_mesa
+
+    iget-object v13, v12, Lcom/android/systemui/keyguard/KeyguardFastBioUnlockController;->biometricSourceType:Landroid/hardware/biometrics/BiometricSourceType;
+
+    sget-object v14, Landroid/hardware/biometrics/BiometricSourceType;->FINGERPRINT:Landroid/hardware/biometrics/BiometricSourceType;
+
+    if-ne v13, v14, :cond_mesa
+
+    move v13, v6
+
+    goto :goto_mesa
+
+    :cond_mesa
+    move v13, v5
+
+    :goto_mesa
+    if-eqz v13, :cond_mesa2
+
+    iget-object v13, v0, Lcom/android/systemui/keyguard/KeyguardViewMediatorHelperImpl;->updateMonitor:Lcom/android/keyguard/KeyguardUpdateMonitor;
+
+    invoke-interface {v13}, Lcom/android/keyguard/KeyguardSecUpdateMonitor;->removeMaskViewForOpticalFpSensor()V
+
+    :cond_mesa2
     iget-object v13, v1, Lcom/android/systemui/keyguard/KeyguardViewMediator$StartKeyguardExitAnimParams;->mApps:[Landroid/view/RemoteAnimationTarget;
 
     if-eqz v13, :cond_13
diff --git a/smali_classes2/com/android/systemui/shade/SecNotificationShadeWindowControllerHelperImpl.smali b/smali_classes2/com/android/systemui/shade/SecNotificationShadeWindowControllerHelperImpl.smali
index c2c8d537..61632876 100644
--- a/smali_classes2/com/android/systemui/shade/SecNotificationShadeWindowControllerHelperImpl.smali
+++ b/smali_classes2/com/android/systemui/shade/SecNotificationShadeWindowControllerHelperImpl.smali
@@ -108,7 +108,7 @@
 
     const/4 v1, -0x1
 
-    const/4 v2, 0x0
+    const/4 v2, 0x1
 
     if-ne v0, v1, :cond_0
 
@@ -117,23 +117,24 @@
     :cond_0
     sget v0, Lcom/android/systemui/util/DeviceType;->supportOpticalFingerprint:I
 
-    const/4 v1, 0x1
-
-    if-ne v0, v1, :cond_1
+    if-ne v0, v2, :cond_1
 
-    move v2, v1
+    goto :goto_0
 
     :cond_1
+    const/4 v2, 0x0
+
+    :goto_0
     if-eqz v2, :cond_2
 
     const v0, 0x3d8f5c29    # 0.07f
 
-    goto :goto_0
+    goto :goto_1
 
     :cond_2
     const v0, 0x3e0ccccd    # 0.1375f
 
-    :goto_0
+    :goto_1
     sput v0, Lcom/android/systemui/shade/SecNotificationShadeWindowControllerHelperImpl;->BLUR_AMOUNT:F
 
     const/16 v0, 0x1388
@@ -399,8 +400,17 @@
 
     iput v0, p1, Landroid/view/WindowManager$LayoutParams;->samsungFlags:I
 
-    sget-object v0, Lcom/android/systemui/LsRune;->VALUE_CONFIG_CARRIER_TEXT_POLICY:Ljava/lang/String;
+    sget-boolean v1, Lcom/android/systemui/LsRune;->SECURITY_FINGERPRINT_IN_DISPLAY_OPTICAL:Z
+
+    if-eqz v1, :cond_1
+
+    const/high16 v1, 0x20000
+
+    or-int/2addr v0, v1
+
+    iput v0, p1, Landroid/view/WindowManager$LayoutParams;->samsungFlags:I
 
+    :cond_1
     invoke-virtual {p0}, Lcom/android/systemui/shade/SecNotificationShadeWindowControllerHelperImpl;->getCurrentState()Lcom/android/systemui/shade/NotificationShadeWindowState;
 
     move-result-object v0
@@ -409,7 +419,7 @@
 
     const/4 v2, 0x1
 
-    if-ne v1, v2, :cond_1
+    if-ne v1, v2, :cond_2
 
     iget-wide v0, v0, Lcom/android/systemui/shade/NotificationShadeWindowState;->keyguardUserActivityTimeout:J
 
@@ -417,16 +427,16 @@
 
     cmp-long v5, v0, v3
 
-    if-gez v5, :cond_2
+    if-gez v5, :cond_3
 
     move-wide v0, v3
 
     goto :goto_1
 
-    :cond_1
+    :cond_2
     const-wide/16 v0, -0x1
 
-    :cond_2
+    :cond_3
     :goto_1
     iput-wide v0, p1, Landroid/view/WindowManager$LayoutParams;->userActivityTimeout:J
 
diff --git a/smali_classes2/com/android/systemui/statusbar/phone/CentralSurfacesImpl.smali b/smali_classes2/com/android/systemui/statusbar/phone/CentralSurfacesImpl.smali
index 768566c1..743936ca 100644
--- a/smali_classes2/com/android/systemui/statusbar/phone/CentralSurfacesImpl.smali
+++ b/smali_classes2/com/android/systemui/statusbar/phone/CentralSurfacesImpl.smali
@@ -3763,19 +3763,30 @@
 
     iput v4, v2, Landroid/view/InsetsFlags;->behavior:I
 
-    sget-object v2, Lcom/android/systemui/LsRune;->VALUE_CONFIG_CARRIER_TEXT_POLICY:Ljava/lang/String;
+    sget-boolean v2, Lcom/android/systemui/LsRune;->SECURITY_FINGERPRINT_IN_DISPLAY_OPTICAL:Z
 
+    if-eqz v2, :cond_1d
+
+    iget v2, v1, Landroid/view/WindowManager$LayoutParams;->samsungFlags:I
+
+    const/high16 v4, 0x20000
+
+    or-int/2addr v2, v4
+
+    iput v2, v1, Landroid/view/WindowManager$LayoutParams;->samsungFlags:I
+
+    :cond_1d
     iget-object v2, v3, Lcom/android/systemui/shade/NotificationShadeWindowControllerImpl;->mIndicatorCutoutUtil:Lcom/android/systemui/statusbar/phone/IndicatorCutoutUtil;
 
     iget-boolean v2, v2, Lcom/android/systemui/statusbar/phone/IndicatorCutoutUtil;->isUDCModel:Z
 
-    if-eqz v2, :cond_1d
+    if-eqz v2, :cond_1e
 
     const/16 v2, 0x2000
 
     invoke-virtual {v1, v2}, Landroid/view/WindowManager$LayoutParams;->semAddExtensionFlags(I)V
 
-    :cond_1d
+    :cond_1e
     iget-object v1, v3, Lcom/android/systemui/shade/NotificationShadeWindowControllerImpl;->mNotificationShadeView:Landroid/view/ViewGroup;
 
     iget-object v2, v3, Lcom/android/systemui/shade/NotificationShadeWindowControllerImpl;->mLp:Landroid/view/WindowManager$LayoutParams;
@@ -3798,7 +3809,7 @@
 
     move-result v1
 
-    if-eqz v1, :cond_1e
+    if-eqz v1, :cond_1f
 
     iget-object v1, v3, Lcom/android/systemui/shade/NotificationShadeWindowControllerImpl;->mCurrentState:Lcom/android/systemui/shade/NotificationShadeWindowState;
 
@@ -3810,7 +3821,7 @@
 
     goto :goto_d
 
-    :cond_1e
+    :cond_1f
     const/4 v2, 0x1
 
     :goto_d
@@ -3822,7 +3833,7 @@
 
     iget-object v3, v2, Lcom/android/systemui/shade/SecNotificationShadeWindowControllerHelperImpl;->pluginLockMediator:Lcom/android/systemui/pluginlock/PluginLockMediator;
 
-    if-eqz v3, :cond_20
+    if-eqz v3, :cond_21
 
     iget-object v4, v2, Lcom/android/systemui/shade/SecNotificationShadeWindowControllerHelperImpl;->notificationShadeView:Landroid/view/ViewGroup;
 
@@ -3836,7 +3847,7 @@
 
     iget-object v5, v3, Lcom/android/systemui/pluginlock/PluginLockMediatorImpl;->mSPluginManager:Lcom/samsung/systemui/splugins/SPluginManager;
 
-    if-eqz v5, :cond_1f
+    if-eqz v5, :cond_20
 
     const-class v7, Lcom/samsung/systemui/splugins/pluginlock/PluginLock;
 
@@ -3844,10 +3855,10 @@
 
     invoke-interface {v5, v3, v7, v8}, Lcom/samsung/systemui/splugins/SPluginManager;->addPluginListener(Lcom/samsung/systemui/splugins/SPluginListener;Ljava/lang/Class;Z)V
 
-    :cond_1f
+    :cond_20
     iget-object v3, v3, Lcom/android/systemui/pluginlock/PluginLockMediatorImpl;->mSPluginListener:Lcom/android/systemui/pluginlock/PluginLockManagerImpl;
 
-    if-eqz v3, :cond_20
+    if-eqz v3, :cond_21
 
     new-instance v5, Ljava/lang/StringBuilder;
 
@@ -3875,7 +3886,7 @@
 
     iput-object v4, v3, Lcom/android/systemui/pluginlock/PluginLockDelegateApp;->mRootView:Landroid/view/ViewGroup;
 
-    :cond_20
+    :cond_21
     new-instance v3, Lcom/android/systemui/shade/SecNotificationShadeWindowControllerHelperImpl$attach$1;
 
     invoke-direct {v3, v2}, Lcom/android/systemui/shade/SecNotificationShadeWindowControllerHelperImpl$attach$1;-><init>(Lcom/android/systemui/shade/SecNotificationShadeWindowControllerHelperImpl;)V
@@ -3924,7 +3935,7 @@
 
     iget-object v2, v2, Lcom/android/systemui/wallpaper/KeyguardWallpaperController;->mWallpaperView:Lcom/android/systemui/wallpaper/view/SystemUIWallpaperBase;
 
-    if-eqz v2, :cond_21
+    if-eqz v2, :cond_22
 
     instance-of v2, v2, Lcom/android/systemui/wallpaper/view/KeyguardImageWallpaper;
 
@@ -3934,7 +3945,7 @@
 
     invoke-virtual {v1, v2}, Lcom/android/systemui/shade/NotificationShadeWindowControllerImpl$$ExternalSyntheticLambda11;->accept(Ljava/lang/Object;)V
 
-    :cond_21
+    :cond_22
     iget-object v0, v0, Lcom/android/systemui/statusbar/phone/CentralSurfacesImpl;->mStatusBarWindowController:Lcom/android/systemui/statusbar/window/StatusBarWindowController;
 
     invoke-virtual {v0}, Ljava/lang/Object;->getClass()Ljava/lang/Class;
@@ -3968,7 +3979,7 @@
     const/4 v5, 0x0
 
     :goto_e
-    if-gt v5, v2, :cond_22
+    if-gt v5, v2, :cond_23
 
     iget-object v3, v1, Landroid/view/WindowManager$LayoutParams;->paramsForRotation:[Landroid/view/WindowManager$LayoutParams;
 
@@ -3982,7 +3993,7 @@
 
     goto :goto_e
 
-    :cond_22
+    :cond_23
     iput-object v1, v0, Lcom/android/systemui/statusbar/window/StatusBarWindowController;->mLp:Landroid/view/WindowManager$LayoutParams;
 
     invoke-static {}, Landroid/os/Trace;->endSection()V
diff --git a/smali_classes2/com/android/systemui/statusbar/phone/SecLsScrimControlHelper$1.smali b/smali_classes2/com/android/systemui/statusbar/phone/SecLsScrimControlHelper$1.smali
index 8d69d190..00407490 100644
--- a/smali_classes2/com/android/systemui/statusbar/phone/SecLsScrimControlHelper$1.smali
+++ b/smali_classes2/com/android/systemui/statusbar/phone/SecLsScrimControlHelper$1.smali
@@ -30,7 +30,11 @@
     goto :goto_0
 
     :cond_0
-    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()V
+    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_1
 
     iget-object p0, p0, Lcom/android/systemui/statusbar/phone/SecLsScrimControlHelper$1;->this$0:Lcom/android/systemui/statusbar/phone/SecLsScrimControlHelper;
 
diff --git a/smali_classes2/com/android/systemui/statusbar/phone/SecLsScrimControlHelper.smali b/smali_classes2/com/android/systemui/statusbar/phone/SecLsScrimControlHelper.smali
index e8be8373..9ee9e37c 100644
--- a/smali_classes2/com/android/systemui/statusbar/phone/SecLsScrimControlHelper.smali
+++ b/smali_classes2/com/android/systemui/statusbar/phone/SecLsScrimControlHelper.smali
@@ -444,7 +444,11 @@
 
     if-eqz v0, :cond_2
 
-    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()V
+    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_2
 
     move v0, v1
 
@@ -489,7 +493,7 @@
 
     if-ne v0, v4, :cond_5
 
-    sput v2, Lcom/android/systemui/util/DeviceType;->supportOpticalFingerprint:I
+    sput v1, Lcom/android/systemui/util/DeviceType;->supportOpticalFingerprint:I
 
     :cond_5
     sget v0, Lcom/android/systemui/util/DeviceType;->supportOpticalFingerprint:I
diff --git a/smali_classes2/com/android/systemui/statusbar/phone/StatusBarKeyguardViewManager.smali b/smali_classes2/com/android/systemui/statusbar/phone/StatusBarKeyguardViewManager.smali
index e34e064a..898d9b5b 100644
--- a/smali_classes2/com/android/systemui/statusbar/phone/StatusBarKeyguardViewManager.smali
+++ b/smali_classes2/com/android/systemui/statusbar/phone/StatusBarKeyguardViewManager.smali
@@ -3946,7 +3946,11 @@
     :cond_11
     if-eqz v9, :cond_16
 
-    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()V
+    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()Z
+
+    move-result v14
+
+    if-eqz v14, :cond_16
 
     invoke-virtual {v13}, Ljava/lang/Object;->getClass()Ljava/lang/Class;
 
diff --git a/smali_classes2/com/android/systemui/util/DeviceState.smali b/smali_classes2/com/android/systemui/util/DeviceState.smali
index 948a4792..c09a25b0 100644
--- a/smali_classes2/com/android/systemui/util/DeviceState.smali
+++ b/smali_classes2/com/android/systemui/util/DeviceState.smali
@@ -503,7 +503,7 @@
     return p0
 .end method
 
-.method public static isCapturedBlurAllowed()V
+.method public static isCapturedBlurAllowed()Z
     .locals 2
 
     sget-object v0, Lcom/android/systemui/util/DeviceState;->sDisplaySize:Landroid/graphics/Point;
@@ -525,9 +525,37 @@
     invoke-virtual {v0, v1}, Lcom/samsung/android/view/SemWindowManager;->getInitialDisplaySize(Landroid/graphics/Point;)V
 
     :cond_0
-    sget-object v0, Lcom/android/systemui/LsRune;->VALUE_CONFIG_CARRIER_TEXT_POLICY:Ljava/lang/String;
+    sget-boolean v0, Lcom/android/systemui/LsRune;->SECURITY_FINGERPRINT_IN_DISPLAY_OPTICAL:Z
 
-    return-void
+    if-eqz v0, :cond_2
+
+    sget-object v0, Lcom/android/systemui/util/DeviceState;->sDisplaySize:Landroid/graphics/Point;
+
+    iget v1, v0, Landroid/graphics/Point;->x:I
+
+    iget v0, v0, Landroid/graphics/Point;->y:I
+
+    invoke-static {v1, v0}, Ljava/lang/Math;->min(II)I
+
+    move-result v0
+
+    const/16 v1, 0x2d0
+
+    if-le v0, v1, :cond_1
+
+    goto :goto_0
+
+    :cond_1
+    const/4 v0, 0x0
+
+    goto :goto_1
+
+    :cond_2
+    :goto_0
+    const/4 v0, 0x1
+
+    :goto_1
+    return v0
 .end method
 
 .method public static isCenterDisplayCutOut(Landroid/content/Context;)Z
diff --git a/smali_classes2/com/android/systemui/wallpaper/KeyguardWallpaperController$$ExternalSyntheticLambda1.smali b/smali_classes2/com/android/systemui/wallpaper/KeyguardWallpaperController$$ExternalSyntheticLambda1.smali
index c297d758..ba44a676 100644
--- a/smali_classes2/com/android/systemui/wallpaper/KeyguardWallpaperController$$ExternalSyntheticLambda1.smali
+++ b/smali_classes2/com/android/systemui/wallpaper/KeyguardWallpaperController$$ExternalSyntheticLambda1.smali
@@ -178,7 +178,11 @@
 
     if-eqz v0, :cond_6
 
-    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()V
+    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_6
 
     iget-object v0, p0, Lcom/android/systemui/wallpaper/KeyguardWallpaperController;->mWallpaperView:Lcom/android/systemui/wallpaper/view/SystemUIWallpaperBase;
 
diff --git a/smali_classes2/com/android/systemui/wallpaper/KeyguardWallpaperController$$ExternalSyntheticLambda7.smali b/smali_classes2/com/android/systemui/wallpaper/KeyguardWallpaperController$$ExternalSyntheticLambda7.smali
index bf4be258..c1ac2c39 100644
--- a/smali_classes2/com/android/systemui/wallpaper/KeyguardWallpaperController$$ExternalSyntheticLambda7.smali
+++ b/smali_classes2/com/android/systemui/wallpaper/KeyguardWallpaperController$$ExternalSyntheticLambda7.smali
@@ -352,7 +352,11 @@
 
     if-eqz v1, :cond_f
 
-    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()V
+    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()Z
+
+    move-result v1
+
+    if-eqz v1, :cond_f
 
     iget-boolean v1, v0, Lcom/android/systemui/wallpaper/KeyguardWallpaperController;->mIsBlurredViewAdded:Z
 
diff --git a/smali_classes2/com/android/systemui/wallpaper/KeyguardWallpaperController$2.smali b/smali_classes2/com/android/systemui/wallpaper/KeyguardWallpaperController$2.smali
index ebbb23c4..edd74df0 100644
--- a/smali_classes2/com/android/systemui/wallpaper/KeyguardWallpaperController$2.smali
+++ b/smali_classes2/com/android/systemui/wallpaper/KeyguardWallpaperController$2.smali
@@ -52,7 +52,11 @@
 
     if-eqz v0, :cond_0
 
-    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()V
+    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_0
 
     iget-object v0, p0, Lcom/android/systemui/wallpaper/KeyguardWallpaperController;->mBlurredView:Lcom/android/systemui/wallpaper/view/KeyguardBlurredWallpaper;
 
diff --git a/smali_classes2/com/android/systemui/wallpaper/KeyguardWallpaperController$6.smali b/smali_classes2/com/android/systemui/wallpaper/KeyguardWallpaperController$6.smali
index 3351f300..549afc66 100644
--- a/smali_classes2/com/android/systemui/wallpaper/KeyguardWallpaperController$6.smali
+++ b/smali_classes2/com/android/systemui/wallpaper/KeyguardWallpaperController$6.smali
@@ -925,7 +925,11 @@
 
     if-eqz p1, :cond_20
 
-    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()V
+    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()Z
+
+    move-result p1
+
+    if-eqz p1, :cond_20
 
     iget-object p1, p0, Lcom/android/systemui/wallpaper/KeyguardWallpaperController;->mWallpaperView:Lcom/android/systemui/wallpaper/view/SystemUIWallpaperBase;
 
@@ -1001,7 +1005,11 @@
 
     if-eqz p1, :cond_22
 
-    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()V
+    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()Z
+
+    move-result p1
+
+    if-eqz p1, :cond_22
 
     iget-object p1, p0, Lcom/android/systemui/wallpaper/KeyguardWallpaperController;->mWallpaperView:Lcom/android/systemui/wallpaper/view/SystemUIWallpaperBase;
 
diff --git a/smali_classes2/com/android/systemui/wallpaper/KeyguardWallpaperController.smali b/smali_classes2/com/android/systemui/wallpaper/KeyguardWallpaperController.smali
index 4cbb18e3..46511277 100644
--- a/smali_classes2/com/android/systemui/wallpaper/KeyguardWallpaperController.smali
+++ b/smali_classes2/com/android/systemui/wallpaper/KeyguardWallpaperController.smali
@@ -909,7 +909,11 @@
 
     if-eqz v0, :cond_4
 
-    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()V
+    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_4
 
     iget-object v0, p0, Lcom/android/systemui/wallpaper/KeyguardWallpaperController;->mBlurredView:Lcom/android/systemui/wallpaper/view/KeyguardBlurredWallpaper;
 
@@ -2629,7 +2633,11 @@
 
     if-eqz v0, :cond_7
 
-    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()V
+    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_7
 
     iput-boolean v6, p0, Lcom/android/systemui/wallpaper/KeyguardWallpaperController;->mWallpaperChanged:Z
 
@@ -2987,7 +2995,11 @@
 
     if-eqz v0, :cond_8
 
-    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()V
+    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_8
 
     invoke-virtual {v7, v14}, Lcom/android/systemui/wallpaper/KeyguardWallpaperController;->handleDlsViewModeDelayed(I)V
 
@@ -3048,7 +3060,11 @@
 
     if-eqz v0, :cond_d
 
-    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()V
+    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_d
 
     iget-boolean v0, v7, Lcom/android/systemui/wallpaper/KeyguardWallpaperController;->mIsBlurredViewAdded:Z
 
@@ -3682,7 +3698,11 @@
 
     if-eqz v0, :cond_18
 
-    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()V
+    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_18
 
     move/from16 v14, v26
 
@@ -5897,7 +5917,11 @@
 
     if-eqz v0, :cond_1
 
-    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()V
+    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()Z
+
+    move-result v0
+
+    if-eqz v0, :cond_1
 
     iget-boolean v0, p0, Lcom/android/systemui/wallpaper/KeyguardWallpaperController;->mOccluded:Z
 
diff --git a/smali_classes2/com/android/systemui/wallpaper/view/KeyguardAnimatedWallpaper.smali b/smali_classes2/com/android/systemui/wallpaper/view/KeyguardAnimatedWallpaper.smali
index b8242d53..2faa2a0f 100644
--- a/smali_classes2/com/android/systemui/wallpaper/view/KeyguardAnimatedWallpaper.smali
+++ b/smali_classes2/com/android/systemui/wallpaper/view/KeyguardAnimatedWallpaper.smali
@@ -683,7 +683,11 @@
 
     if-eqz p1, :cond_1
 
-    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()V
+    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()Z
+
+    move-result p1
+
+    if-eqz p1, :cond_1
 
     iget-object p1, p0, Lcom/android/systemui/wallpaper/view/SystemUIWallpaper;->mWallpaperResultCallback:Lcom/android/systemui/wallpaper/WallpaperResultCallback;
 
diff --git a/smali_classes2/com/android/systemui/wallpaper/view/KeyguardImageWallpaper.smali b/smali_classes2/com/android/systemui/wallpaper/view/KeyguardImageWallpaper.smali
index 44ab1706..be5e047f 100644
--- a/smali_classes2/com/android/systemui/wallpaper/view/KeyguardImageWallpaper.smali
+++ b/smali_classes2/com/android/systemui/wallpaper/view/KeyguardImageWallpaper.smali
@@ -2815,7 +2815,11 @@
 
     if-eqz v1, :cond_21
 
-    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()V
+    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()Z
+
+    move-result v1
+
+    if-eqz v1, :cond_21
 
     iget-object v0, v0, Lcom/android/systemui/wallpaper/view/SystemUIWallpaper;->mWallpaperResultCallback:Lcom/android/systemui/wallpaper/WallpaperResultCallback;
 
diff --git a/smali_classes2/com/android/systemui/wallpaper/view/KeyguardVideoWallpaper.smali b/smali_classes2/com/android/systemui/wallpaper/view/KeyguardVideoWallpaper.smali
index b0b48ede..e5d25006 100644
--- a/smali_classes2/com/android/systemui/wallpaper/view/KeyguardVideoWallpaper.smali
+++ b/smali_classes2/com/android/systemui/wallpaper/view/KeyguardVideoWallpaper.smali
@@ -1826,7 +1826,11 @@
 
     if-eqz p1, :cond_0
 
-    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()V
+    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()Z
+
+    move-result p1
+
+    if-eqz p1, :cond_0
 
     iget-boolean p1, p0, Lcom/android/systemui/wallpaper/view/KeyguardVideoWallpaper;->mIsBlurEnabled:Z
 
@@ -2558,7 +2562,11 @@
 
     if-eqz v3, :cond_2
 
-    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()V
+    invoke-static {}, Lcom/android/systemui/util/DeviceState;->isCapturedBlurAllowed()Z
+
+    move-result v3
+
+    if-eqz v3, :cond_2
 
     if-eqz v0, :cond_1
 
-- 
2.45.2

